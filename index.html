<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Acareações</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
            overflow-x: hidden; /* Previne barra horizontal no body */
        }
        /* Estilos da barra de rolagem */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
         /* Estilo para o spinner de carregamento inicial */
        #initial-loading {
            position: fixed;
            inset: 0;
            background-color: rgba(248, 250, 252, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Loading Inicial -->
    <div id="initial-loading">
        <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Elemento de Notificação -->
    <div id="notification" class="hidden fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white transition-opacity duration-300 max-w-sm">
        <p id="notification-message"></p>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-slate-800" id="modal-title">Confirmar Ação</h3>
            <p class="mt-2 text-sm text-slate-600" id="modal-message">Você tem certeza?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Painel de Controle de Acareações</h1>
                <p class="text-slate-600 mt-1">Acompanhe o status dos seus documentos em tempo real.</p>
            </div>
            <div class="flex items-center space-x-4 md:space-x-6 mt-4 sm:mt-0">
                <!-- Logo J&T Express -->
                <img src="https://www.jtexpress.com.br/mobile/static/png/leader_1-c3f7a853.png" alt="Logo J&T Express" class="h-16 w-auto" onerror="this.style.display='none'">
                <!-- Nova Logo J&T Express -->
                <img src="https://yl-pufile.jtexpress.ph/osbforever/YL_JMS_OFFICIAL_MANAGE/INFORMATION/20241104/1730704731890-1092-OurServices001.png" alt="Nova Logo J&T Express" class="h-16 w-auto" onerror="this.style.display='none'">
            </div>
        </header>

        <!-- Grade de Status -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-8">
             <!-- Pendentes -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex items-start space-x-4">
                <div class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center">
                    <svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div><h3 class="text-sm font-semibold text-slate-500 uppercase">Pendentes</h3><p id="pending-count" class="text-3xl font-bold text-indigo-600 mt-1">0</p></div>
            </div>
            <!-- Impressos -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex items-start space-x-4">
                <div class="bg-sky-100 rounded-full w-12 h-12 flex items-center justify-center">
                    <svg class="h-6 w-6 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h4.5a2.25 2.25 0 012.25 2.25v.75" />
                    </svg>
                </div>
                <div><h3 class="text-sm font-semibold text-slate-500 uppercase">Impressos</h3><p id="printed-count" class="text-3xl font-bold text-sky-600 mt-1">0</p></div>
            </div>
            <!-- Em Alerta -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex items-start space-x-4">
                <div class="bg-amber-100 rounded-full w-12 h-12 flex items-center justify-center">
                    <svg class="h-6 w-6 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
                </div>
                <div><h3 class="text-sm font-semibold text-slate-500 uppercase">Em Alerta</h3><p id="alert-count" class="text-3xl font-bold text-amber-500 mt-1">0</p></div>
            </div>
            <!-- Vencidos -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex items-start space-x-4">
                <div class="bg-red-100 rounded-full w-12 h-12 flex items-center justify-center">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
                <div><h3 class="text-sm font-semibold text-slate-500 uppercase">Vencidos</h3><p id="expired-count" class="text-3xl font-bold text-red-600 mt-1">0</p></div>
            </div>
            <!-- Extravio Motorista -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex items-start space-x-4">
                <div class="bg-orange-100 rounded-full w-12 h-12 flex items-center justify-center">
                    <svg class="h-6 w-6 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h.008v.008h-.008v-.008zm0 0H20.625a1.125 1.125 0 001.125-1.125V14.25m-17.25 4.5h14.25m-14.25 0V6.75a1.125 1.125 0 011.125-1.125h14.25a1.125 1.125 0 011.125 1.125v10.5m-17.25 4.5H3.375m17.25 0H20.625m0 0a1.125 1.125 0 001.125-1.125V6.75a1.125 1.125 0 00-1.125-1.125H3.375a1.125 1.125 0 00-1.125 1.125v10.5a1.125 1.125 0 001.125 1.125h.008m17.25 0h.008v.008h-.008v-.008zm0 0H20.625" />
                    </svg>
                </div>
                <div><h3 class="text-sm font-semibold text-slate-500 uppercase">Extravio Motorista</h3><p id="extravio-motorista-count" class="text-3xl font-bold text-orange-600 mt-1">0</p></div>
            </div>
            <!-- Extravio Base -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex items-start space-x-4">
                <div class="bg-teal-100 rounded-full w-12 h-12 flex items-center justify-center">
                    <svg class="h-6 w-6 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.75M9 11.25h6.75M9 15.75h6.75M5.25 6h.008v.008H5.25V6zm.008 4.5h.008v.008H5.25v-.008zm0 4.5h.008v.008H5.25v-.008zm13.5-9h.008v.008h-.008V6zm0 4.5h.008v.008h-.008v-.008zm0 4.5h.008v.008h-.008v-.008z" />
                    </svg>
                </div>
                <div><h3 class="text-sm font-semibold text-slate-500 uppercase">Extravio Base</h3><p id="extravio-base-count" class="text-3xl font-bold text-teal-600 mt-1">0</p></div>
            </div>
            <!-- Solucionados -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex items-start space-x-4">
                 <div class="bg-emerald-100 rounded-full w-12 h-12 flex items-center justify-center">
                    <svg class="h-6 w-6 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div><h3 class="text-sm font-semibold text-slate-500 uppercase">Solucionados</h3><p id="solved-count" class="text-3xl font-bold text-emerald-600 mt-1">0</p></div>
            </div>
        </div>

        <!-- Filtros de Data -->
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-slate-200 mb-8 flex flex-col sm:flex-row gap-4 items-center">
            <h3 class="text-lg font-semibold text-slate-700 whitespace-nowrap">Filtrar por Data:</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 w-full">
                <div>
                    <label for="month-filter" class="block text-sm font-medium text-slate-700">Mês</label>
                    <select id="month-filter" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="all">Todos os Meses</option>
                        <option value="0">Janeiro</option>
                        <option value="1">Fevereiro</option>
                        <option value="2">Março</option>
                        <option value="3">Abril</option>
                        <option value="4">Maio</option>
                        <option value="5">Junho</option>
                        <option value="6">Julho</option>
                        <option value="7">Agosto</option>
                        <option value="8">Setembro</option>
                        <option value="9">Outubro</option>
                        <option value="10">Novembro</option>
                        <option value="11">Dezembro</option>
                    </select>
                </div>
                <div>
                    <label for="year-filter" class="block text-sm font-medium text-slate-700">Ano</label>
                    <select id="year-filter" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="all">Todos os Anos</option>
                        <!-- Anos serão preenchidos por JS -->
                    </select>
                </div>
                <div class="sm:self-end">
                    <button id="reset-filter-btn" class="w-full px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                        Mostrar Mês Atual
                    </button>
                </div>
            </div>
        </div>

        <!-- Seção da Lista de Arquivos Pendentes -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-8">
            <h2 class="text-xl font-semibold text-slate-800 p-6">Documentos Pendentes</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3">Nome do Arquivo</th>
                            <th scope="col" class="px-6 py-3">Pasta</th>
                            <th scope="col" class="px-6 py-3">Prazo Final</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3">Notif. Wpp</th>
                            <th scope="col" class="px-6 py-3 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="file-list" class="divide-y divide-slate-200">
                        <tr id="empty-state-pending"><td colspan="6" class="text-center py-10 text-slate-500">Nenhum documento pendente.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seção da Lista de Arquivos Impressos -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-8">
            <h2 class="text-xl font-semibold text-slate-800 p-6">Documentos Impressos Aguardando Solução</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3">Nome do Arquivo</th>
                            <th scope="col" class="px-6 py-3">Pasta</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="printed-file-list" class="divide-y divide-slate-200">
                        <tr id="empty-state-printed"><td colspan="4" class="text-center py-10 text-slate-500">Nenhum documento impresso.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Seção da Lista de Arquivos Vencidos -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-8">
            <h2 class="text-xl font-semibold text-slate-800 p-6">Documentos Vencidos</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3">Nome do Arquivo</th>
                            <th scope="col" classs="px-6 py-3">Pasta</th>
                            <th scope="col" class="px-6 py-3">Data de Envio</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="expired-file-list" class="divide-y divide-slate-200">
                         <tr id="empty-state-expired"><td colspan="5" class="text-center py-10 text-slate-500">Nenhum documento vencido.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seção da Lista de Extravio Motorista -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-8">
            <h2 class="text-xl font-semibold text-slate-800 p-6">Extravio Motorista</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3">Nome do Arquivo</th>
                            <th scope="col" class="px-6 py-3">Pasta</th>
                            <th scope="col" class="px-6 py-3">Data de Envio</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="extravio-motorista-list" class="divide-y divide-slate-200">
                         <tr id="empty-state-extravio-motorista"><td colspan="5" class="text-center py-10 text-slate-500">Nenhum documento em extravio motorista.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seção da Lista de Extravio Base -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-8">
            <h2 class="text-xl font-semibold text-slate-800 p-6">Extravio Base</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3">Nome do Arquivo</th>
                            <th scope="col" class="px-6 py-3">Pasta</th>
                            <th scope="col" class="px-6 py-3">Data de Envio</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="extravio-base-list" class="divide-y divide-slate-200">
                         <tr id="empty-state-extravio-base"><td colspan="5" class="text-center py-10 text-slate-500">Nenhum documento em extravio base.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Seção para Adicionar Novo Documento -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
            <h2 class="text-xl font-semibold text-slate-800 mb-4">Enviar Nova Acareação (PDF)</h2>
             <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 mb-4 rounded-r-lg" role="alert">
                 <p>
                    <strong>Atenção:</strong> Arquivos grandes (acima de 1MB) podem demorar para carregar ou causar erros.
                 </p>
             </div>
            <form id="upload-form" class="space-y-4">
                <div>
                    <label for="folder-name" class="block text-sm font-medium text-slate-700 mb-1">Data do Envio</label>
                    <input type="date" id="folder-name" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="upload-time" class="block text-sm font-medium text-slate-700 mb-1">Horário do Envio (Prazo de 24h começa aqui)</label>
                    <input type="time" id="upload-time" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="pdf-file-input" class="block w-full text-sm font-medium text-slate-700 mb-1">Selecione os arquivos PDF (múltiplos)</label>
                    <input type="file" id="pdf-file-input" accept=".pdf" required multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
                 <button type="submit" id="submit-button" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 flex items-center justify-center space-x-2">
                    <svg id="submit-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="submit-text">Subir Arquivo(s)</span>
                </button>
            </form>
        </div>

        <!-- Seção de Ações -->
        <div class="mt-8 pt-6 border-t border-slate-200 text-center">
             <button id="clear-data-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 text-sm flex items-center justify-center space-x-2 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                <span>Limpar Todos os Dados</span>
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // -------------------------------------------------------------------------
            // URL DO BANCO DE DADOS ONLINE - CONFIGURADO E PRONTO
            const DATABASE_URL = "https://api.npoint.io/ef789e8a4e2cd9900cf7";
            // -------------------------------------------------------------------------
            
            // --- Variáveis Globais ---
            let AppState = { files: [], solvedCount: 0 }; // Estado local
            let isSaving = false; // Flag para evitar conflitos
            let autoUpdateInterval; // Referência para o intervalo

            // --- Verificação da URL ---
            if (!DATABASE_URL || DATABASE_URL === "COLE_SUA_URL_AQUI") {
                 document.body.innerHTML = `
                      <div class="h-screen w-screen flex items-center justify-center bg-slate-50 p-4">
                           <div class="text-center p-8 bg-white rounded-lg shadow-xl max-w-lg">
                                <h1 class="text-2xl font-bold text-red-600">Configuração Necessária</h1>
                                <p class="text-slate-600 mt-2">Por favor, siga as instruções para criar seu banco de dados online gratuito no site npoint.io e cole a URL gerada na variável DATABASE_URL dentro do código deste arquivo.</p>
                           </div>
                      </div>`;
                return;
            }

            // --- Elementos da UI ---
            const loadingEl = document.getElementById('initial-loading');
            const form = document.getElementById('upload-form');
            const folderInput = document.getElementById('folder-name');
            const fileInput = document.getElementById('pdf-file-input');
            const timeInput = document.getElementById('upload-time');
            const submitButton = document.getElementById('submit-button');
            const clearDataBtn = document.getElementById('clear-data-btn');
            
            const pendingFileList = document.getElementById('file-list');
            const printedFileList = document.getElementById('printed-file-list');
            const expiredFileList = document.getElementById('expired-file-list');
            const extravioMotoristaList = document.getElementById('extravio-motorista-list');
            const extravioBaseList = document.getElementById('extravio-base-list');

            const pendingCountEl = document.getElementById('pending-count');
            const printedCountEl = document.getElementById('printed-count');
            const alertCountEl = document.getElementById('alert-count');
            const expiredCountEl = document.getElementById('expired-count');
            const solvedCountEl = document.getElementById('solved-count');
            const extravioMotoristaCountEl = document.getElementById('extravio-motorista-count');
            const extravioBaseCountEl = document.getElementById('extravio-base-count');

            const monthFilterEl = document.getElementById('month-filter');
            const yearFilterEl = document.getElementById('year-filter');
            const resetFilterBtn = document.getElementById('reset-filter-btn');

            const modal = document.getElementById('confirmation-modal');
            const notificationEl = document.getElementById('notification');
            const notificationMessageEl = document.getElementById('notification-message');
            
            const ALERT_THRESHOLD = 2 * 60 * 60 * 1000; // 2 horas

            // --- Funções de Notificação e Modal ---
            let notificationTimeout;
            function showNotification(message, isError = false) {
                clearTimeout(notificationTimeout);
                notificationMessageEl.textContent = message;
                notificationEl.classList.remove('hidden', 'bg-red-500', 'bg-amber-500', 'bg-emerald-500', 'bg-sky-500'); // Limpa todas as cores
                
                let colorClass = 'bg-emerald-500'; // Sucesso padrão
                if (isError) {
                    colorClass = 'bg-red-500'; // Erro
                } else if (message.includes("Atenção:") || message.includes("Reparando")) {
                     colorClass = 'bg-amber-500'; // Alerta
                } else if (message.includes("atualizada") || message.includes("Filtro redefinido")) {
                     colorClass = 'bg-sky-500'; // Info
                }

                notificationEl.classList.add(colorClass); 
                notificationEl.classList.remove('hidden');
                
                notificationTimeout = setTimeout(() => {
                    notificationEl.classList.add('hidden');
                }, 4000);
            }

            function openConfirmationModal({ title, message }) {
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.classList.remove('hidden');

                return new Promise((resolve) => {
                    const confirmHandler = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                        confirmBtn.removeEventListener('click', confirmHandler);
                        cancelBtn.removeEventListener('click', cancelHandler);
                    };
                    const cancelHandler = () => {
                        modal.classList.add('hidden');
                        resolve(false);
                        confirmBtn.removeEventListener('click', confirmHandler);
                        cancelBtn.removeEventListener('click', cancelHandler);
                    };
                    confirmBtn.addEventListener('click', confirmHandler);
                    cancelBtn.addEventListener('click', cancelHandler);
                });
            }

            // --- Funções de Dados (GET e PUT) ---
            
            async function getLatestData() {
                try {
                    const response = await fetch(`${DATABASE_URL}?_=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const data = await response.json();
                    if (!data.files) data.files = [];
                    if (!data.solvedCount) data.solvedCount = 0;
                    return data;
                } catch (error) {
                    console.error("Erro ao buscar dados:", error);
                    showNotification("Não foi possível carregar os dados. Verifique sua conexão.", true);
                    return null; 
                }
            }
            
            async function saveData(dataToSave) {
                if (isSaving) return false; // CORREÇÃO: Retorna falha se já estiver salvando
                isSaving = true;
                clearInterval(autoUpdateInterval); 

                try {
                    const response = await fetch(DATABASE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    return true; // CORREÇÃO: Retorna sucesso
                } catch (error) {
                    console.error("Erro ao salvar dados:", error); 
                    showNotification("Ocorreu um erro ao salvar as alterações.", true);
                    return false; // CORREÇÃO: Retorna falha
                } finally {
                    isSaving = false; 
                    startAutoUpdate(); 
                }
            }
            
            // --- Lógica de Renderização ---
            function render(data) {
                const now = new Date().getTime();
                let needsStatusUpdate = false;
                
                if (!data) data = { files: [], solvedCount: 0 };

                const monthFilter = monthFilterEl.value;
                const yearFilter = yearFilterEl.value;

                const filteredFiles = data.files.filter(file => {
                    if (!file.uploadDate) return false; 
                    
                    const fileDate = new Date(file.uploadDate);
                    const fileMonth = fileDate.getMonth();
                    const fileYear = fileDate.getFullYear();

                    const yearMatch = (yearFilter === 'all') || (fileYear === parseInt(yearFilter));
                    const monthMatch = (monthFilter === 'all') || (fileMonth === parseInt(monthFilter));

                    return yearMatch && monthMatch;
                });
                
                filteredFiles.forEach(file => {
                    if ((file.status === 'pending' || file.status === 'impresso') && now > file.deadline) {
                        file.status = 'expired';
                        needsStatusUpdate = true;
                    }
                });
                
                pendingFileList.innerHTML = '';
                printedFileList.innerHTML = '';
                expiredFileList.innerHTML = '';
                extravioMotoristaList.innerHTML = '';
                extravioBaseList.innerHTML = '';

                let alertCount = 0;

                const pendingFiles = filteredFiles.filter(f => f.status === 'pending');
                const printedFiles = filteredFiles.filter(f => f.status === 'impresso');
                const expiredFiles = filteredFiles.filter(f => f.status === 'expired');
                const extravioMotoristaFiles = filteredFiles.filter(f => f.status === 'extravio_motorista');
                const extravioBaseFiles = filteredFiles.filter(f => f.status === 'extravio_base');

                // Renderiza Tabela Pendentes
                if (pendingFiles.length === 0) {
                    pendingFileList.innerHTML = `<tr id="empty-state-pending"><td colspan="6" class="text-center py-10 text-slate-500">Nenhum documento pendente.</td></tr>`;
                } else {
                    pendingFiles.sort((a, b) => a.deadline - b.deadline).forEach(file => {
                        const timeLeft = file.deadline - now;
                        const isAlerting = timeLeft > 0 && timeLeft < ALERT_THRESHOLD;
                        if (isAlerting) {
                            alertCount++;
                            if (!file.alertNotified) {
                                showNotification(`Atenção: O documento '${file.fileName}' está prestes a vencer!`, false);
                                file.alertNotified = true;
                                needsStatusUpdate = true;
                            }
                        }
                        pendingFileList.insertAdjacentHTML('beforeend', createPendingRow(file, isAlerting));
                    });
                }

                // Renderiza Tabela Impressos
                if (printedFiles.length === 0) {
                    printedFileList.innerHTML = `<tr id="empty-state-printed"><td colspan="4" class="text-center py-10 text-slate-500">Nenhum documento impresso.</td></tr>`;
                } else {
                    printedFiles.sort((a, b) => a.deadline - b.deadline).forEach(file => printedFileList.insertAdjacentHTML('beforeend', createPrintedRow(file)));
                }

                // Renderiza Tabela Vencidos
                if (expiredFiles.length === 0) {
                    expiredFileList.innerHTML = `<tr id="empty-state-expired"><td colspan="5" class="text-center py-10 text-slate-500">Nenhum documento vencido.</td></tr>`;
                } else {
                    expiredFiles.sort((a, b) => b.uploadDate - a.uploadDate).forEach(file => expiredFileList.insertAdjacentHTML('beforeend', createExpiredRow(file)));
                }

                // Renderiza Tabela Extravio Motorista
                if (extravioMotoristaFiles.length === 0) {
                    extravioMotoristaList.innerHTML = `<tr id="empty-state-extravio-motorista"><td colspan="5" class="text-center py-10 text-slate-500">Nenhum documento em extravio motorista.</td></tr>`;
                } else {
                    extravioMotoristaFiles.sort((a, b) => b.uploadDate - a.uploadDate).forEach(file => extravioMotoristaList.insertAdjacentHTML('beforeend', createExtravioMotoristaRow(file)));
                }

                // Renderiza Tabela Extravio Base
                if (extravioBaseFiles.length === 0) {
                    extravioBaseList.innerHTML = `<tr id="empty-state-extravio-base"><td colspan="5" class="text-center py-10 text-slate-500">Nenhum documento em extravio base.</td></tr>`;
                } else {
                    extravioBaseFiles.sort((a, b) => b.uploadDate - a.uploadDate).forEach(file => extravioBaseList.insertAdjacentHTML('beforeend', createExtravioBaseRow(file)));
                }
                
                pendingCountEl.textContent = pendingFiles.length;
                printedCountEl.textContent = printedFiles.length;
                alertCountEl.textContent = alertCount;
                expiredCountEl.textContent = expiredFiles.length;
                solvedCountEl.textContent = data.solvedCount || 0;
                extravioMotoristaCountEl.textContent = extravioMotoristaFiles.length;
                extravioBaseCountEl.textContent = extravioBaseFiles.length;

                if (needsStatusUpdate) {
                    AppState = data; 
                    saveData(AppState); 
                }
                
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }

            // --- Funções de Criação de Linhas ---
            
            function createPendingRow(file, isAlerting) {
                const deadlineFormatted = new Date(file.deadline).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                const statusClass = isAlerting ? 'bg-amber-100 text-amber-800' : 'bg-indigo-100 text-indigo-800';
                const statusText = isAlerting ? 'Expirando' : 'Pendente';

                const wppNotified = file.whatsappNotified === 'yes';
                const wppStatusText = wppNotified ? 'Sim' : 'Não';
                const wppStatusClass = wppNotified ? 'text-green-600' : 'text-red-600';
                const wppBtnTitle = wppNotified ? 'Marcar como Não Notificado' : 'Marcar como Notificado (Sim)';
                const wppBtnIcon = wppNotified ? 
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-10.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>` :
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`; 

                return `<tr class="bg-white hover:bg-slate-50" data-id="${file.id}">
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap" title="${file.fileName}">${file.fileName}</td>
                            <td class="px-6 py-4">${file.folderName}</td>
                            <td class="px-6 py-4">${deadlineFormatted}</td>
                            <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${statusText}</span></td>
                            
                            <td class="px-6 py-4">
                                <div class="flex items-center justify-center space-x-2">
                                    <span class="font-medium ${wppStatusClass}">${wppStatusText}</span>
                                    <button title="${wppBtnTitle}" class="whatsapp-toggle-btn text-slate-500 hover:text-blue-600">
                                        ${wppBtnIcon}
                                    </button>
                                </div>
                            </td>

                            <td class="px-6 py-4"><div class="flex items-center justify-center space-x-2">
                                <button title="Marcar como Impresso" class="print-btn text-slate-500 hover:text-green-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button title="Acareação Motorista" class="acareacao-motorista-btn text-slate-500 hover:text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Acareação para Base" class="acareacao-base-btn text-slate-500 hover:text-purple-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.496 2.132a1 1 0 00-1.024 0l-7 4.5A1 1 0 002 7.5v8.5a1 1 0 001 1h14a1 1 0 001-1V7.5a1 1 0 00-.471-.868l-7-4.5zM12 11a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm-3 3a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Visualizar" class="view-btn text-slate-500 hover:text-indigo-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.018 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Baixar" class="download-btn text-slate-500 hover:text-emerald-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Solucionar / Excluir" class="delete-btn text-slate-500 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div></td>
                        </tr>`;
            }

            function createPrintedRow(file) {
                return `<tr class="bg-white hover:bg-slate-50" data-id="${file.id}">
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap" title="${file.fileName}">${file.fileName}</td>
                            <td class="px-6 py-4">${file.folderName}</td>
                            <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-sky-100 text-sky-800">Impresso</span></td>
                            <td class="px-6 py-4"><div class="flex items-center justify-center space-x-2">
                                <button title="Acareação Motorista" class="acareacao-motorista-btn text-slate-500 hover:text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Acareação para Base" class="acareacao-base-btn text-slate-500 hover:text-purple-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.496 2.132a1 1 0 00-1.024 0l-7 4.5A1 1 0 002 7.5v8.5a1 1 0 001 1h14a1 1 0 001-1V7.5a1 1 0 00-.471-.868l-7-4.5zM12 11a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm-3 3a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Visualizar" class="view-btn text-slate-500 hover:text-indigo-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.018 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Baixar" class="download-btn text-slate-500 hover:text-emerald-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Solucionar / Excluir" class="delete-btn text-slate-500 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div></td></tr>`;
            }

            function createExpiredRow(file) {
                 const uploadDateFormatted = new Date(file.uploadDate).toLocaleDateString('pt-BR');
                  return `<tr class="bg-white hover:bg-slate-50" data-id="${file.id}">
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap" title="${file.fileName}">${file.fileName}</td>
                            <td class="px-6 py-4">${file.folderName}</td>
                            <td class="px-6 py-4">${uploadDateFormatted}</td>
                            <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Vencido</span></td>
                            <td class="px-6 py-4"><div class="flex items-center justify-center space-x-2">
                                <button title="Acareação Motorista" class="acareacao-motorista-btn text-slate-500 hover:text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Acareação para Base" class="acareacao-base-btn text-slate-500 hover:text-purple-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.496 2.132a1 1 0 00-1.024 0l-7 4.5A1 1 0 002 7.5v8.5a1 1 0 001 1h14a1 1 0 001-1V7.5a1 1 0 00-.471-.868l-7-4.5zM12 11a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm-3 3a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Visualizar" class="view-btn text-slate-500 hover:text-indigo-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.018 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Baixar" class="download-btn text-slate-500 hover:text-emerald-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Solucionar / Excluir" class="delete-btn text-slate-500 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div></td></tr>`;
            }

            function createExtravioMotoristaRow(file) {
                 const uploadDateFormatted = new Date(file.uploadDate).toLocaleDateString('pt-BR');
                  return `<tr class="bg-white hover:bg-slate-50" data-id="${file.id}">
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap" title="${file.fileName}">${file.fileName}</td>
                            <td class="px-6 py-4">${file.folderName}</td>
                            <td class="px-6 py-4">${uploadDateFormatted}</td>
                            <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">Extravio Motorista</span></td>
                            <td class="px-6 py-4"><div class="flex items-center justify-center space-x-2">
                                <button title="Acareação para Base" class="acareacao-base-btn text-slate-500 hover:text-purple-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.496 2.132a1 1 0 00-1.024 0l-7 4.5A1 1 0 002 7.5v8.5a1 1 0 001 1h14a1 1 0 001-1V7.5a1 1 0 00-.471-.868l-7-4.5zM12 11a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0zm-3 3a1 1 0 11-2 0 1 1 0 012 0zm-3 0a1 1 0 11-2 0 1 1 0 012 0zm5 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Visualizar" class="view-btn text-slate-500 hover:text-indigo-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.018 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Baixar" class="download-btn text-slate-500 hover:text-emerald-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Solucionar / Excluir" class="delete-btn text-slate-500 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div></td></tr>`;
            }

            function createExtravioBaseRow(file) {
                 const uploadDateFormatted = new Date(file.uploadDate).toLocaleDateString('pt-BR');
                  return `<tr class="bg-white hover:bg-slate-50" data-id="${file.id}">
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap" title="${file.fileName}">${file.fileName}</td>
                            <td class="px-6 py-4">${file.folderName}</td>
                            <td class="px-6 py-4">${uploadDateFormatted}</td>
                            <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800">Extravio Base</span></td>
                            <td class="px-6 py-4"><div class="flex items-center justify-center space-x-2">
                                <button title="Acareação Motorista" class="acareacao-motorista-btn text-slate-500 hover:text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Visualizar" class="view-btn text-slate-500 hover:text-indigo-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.018 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Baixar" class="download-btn text-slate-500 hover:text-emerald-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                                <button title="Solucionar / Excluir" class="delete-btn text-slate-500 hover:text-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div></td></tr>`;
            }

            // --- Event Listeners ---
            
            clearDataBtn.addEventListener('click', async () => {
                const confirmed = await openConfirmationModal({
                    title: 'Limpar Todos os Dados',
                    message: 'ATENÇÃO: Esta ação é irreversível e irá apagar TODOS os documentos do painel. Você tem certeza absoluta?'
                });
                if (!confirmed) return;
                
                const emptyData = { files: [], solvedCount: 0 };
                AppState = emptyData;
                await saveData(AppState);
                render(AppState); 
                showNotification('Todos os dados foram limpos com sucesso!');
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const submitSpinner = document.getElementById('submit-spinner');
                const submitText = document.getElementById('submit-text');
                submitButton.disabled = true;
                submitSpinner.classList.remove('hidden');
                submitText.textContent = 'Enviando...';

                const resetSubmitButton = () => {
                    submitButton.disabled = false;
                    submitSpinner.classList.add('hidden');
                    submitText.textContent = 'Subir Arquivo(s)';
                };

                const folderName = folderInput.value.trim();
                const uploadTime = timeInput.value.trim();
                const pdfFiles = fileInput.files; 

                if (pdfFiles.length === 0 || !uploadTime || !folderName) {
                    showNotification("Por favor, preencha todos os campos e selecione pelo menos um arquivo.", true);
                    resetSubmitButton();
                    return;
                }
                
                const uploadTimestamp = new Date(`${folderName}T${uploadTime}`).getTime();

                if (isNaN(uploadTimestamp)) {
                    showNotification("Data ou hora inválida.", true);
                    resetSubmitButton();
                    return;
                }

                const failedSizeFiles = [];
                for (let i = 0; i < pdfFiles.length; i++) {
                    if (pdfFiles[i].size > 1024 * 1024) { // 1MB limit
                        failedSizeFiles.push(pdfFiles[i].name);
                    }
                }

                if (failedSizeFiles.length > 0) {
                    showNotification(`Erro: ${failedSizeFiles.length} arquivo(s) são maiores que 1MB: ${failedSizeFiles.join(', ')}`, true);
                    resetSubmitButton();
                    return;
                }

                const fileReadPromises = [];
                for (let i = 0; i < pdfFiles.length; i++) {
                    const pdfFile = pdfFiles[i];
                    const promise = new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const newFile = {
                                id: crypto.randomUUID(), // ID verdadeiramente único
                                fileName: pdfFile.name,
                                folderName: folderName,
                                uploadDate: uploadTimestamp,
                                deadline: uploadTimestamp + (24 * 60 * 60 * 1000), // 24h
                                status: 'pending', 
                                fileURL: e.target.result, 
                                whatsappNotified: 'no' 
                            };
                            resolve(newFile);
                        };
                        reader.onerror = (err) => reject(new Error(`Falha ao ler ${pdfFile.name}`));
                        reader.readAsDataURL(pdfFile);
                    });
                    fileReadPromises.push(promise);
                }

                try {
                    const processedFiles = await Promise.all(fileReadPromises);
                    
                    const currentData = await getLatestData();
                    if (!currentData) {
                        showNotification("Erro de conexão ao salvar. Tente novamente.", true);
                        resetSubmitButton();
                        return;
                    }

                    currentData.files.push(...processedFiles); 
                    AppState = currentData; 

                    await saveData(AppState);
                    
                    // CORREÇÃO: Chamar setupFilters DEPOIS de salvar e ANTES de renderizar
                    // para garantir que o filtro de ano seja atualizado se um novo ano for introduzido.
                    setupFilters();
                    
                    render(AppState); 
                    showNotification(`${processedFiles.length} arquivo(s) enviado(s) com sucesso!`);
                    form.reset();
                    resetSubmitButton();
                } catch (error) {
                    console.error("Erro no processamento em massa:", error);
                    showNotification(`Ocorreu um erro ao processar os arquivos. ${error.message}`, true);
                    resetSubmitButton();
                }
            });

            document.body.addEventListener('click', async (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const row = button.closest('tr');
                if (!row || !row.dataset.id) return;

                const fileId = row.dataset.id;
                
                if (button.classList.contains('view-btn') || button.classList.contains('download-btn')) {
                    const file = AppState.files.find(f => f.id === fileId);
                    if (!file) {
                        showNotification("Arquivo não encontrado no estado local.", true);
                        return;
                    }

                    if (button.classList.contains('view-btn')) {
                        const pdfWindow = window.open("");
                        pdfWindow.document.write(
                            "<html><head><title>" + encodeURIComponent(file.fileName) + "</title></head><body>" +
                            "<style>body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }</style>" +
                            '<iframe width="100%" height="100%" src="' + file.fileURL + '"></iframe>' +
                            "</body></html>"
                        );
                        pdfWindow.document.close();
                    } else if (button.classList.contains('download-btn')) {
                        const link = document.createElement('a');
                        link.href = file.fileURL;
                        link.download = file.fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    return; 
                }

                // --- Ações que MODIFICAM dados ---
                
                const currentData = await getLatestData();
                if (!currentData) {
                    showNotification("Erro de conexão. Sua ação não foi salva. Tente novamente.", true);
                    return;
                }

                const fileIndex = currentData.files.findIndex(f => f.id === fileId);
                if (fileIndex === -1) {
                    showNotification("Arquivo não encontrado no servidor. A lista foi atualizada.", true);
                    AppState = currentData;
                    render(AppState);
                    return;
                }
                
                let needsSave = false;
                let notificationMessage = '';
                
                if (button.classList.contains('print-btn')) {
                    currentData.files[fileIndex].status = 'impresso';
                    needsSave = true;
                    notificationMessage = 'Marcado como impresso!';
                }
                else if (button.classList.contains('delete-btn')) {
                     const confirmed = await openConfirmationModal({
                           title: 'Solucionar Documento',
                           message: `Isso irá remover o documento '${currentData.files[fileIndex].fileName}' permanentemente. Você tem certeza?`
                    });
                    if (!confirmed) return;
                    
                    currentData.files.splice(fileIndex, 1);
                    currentData.solvedCount = (currentData.solvedCount || 0) + 1;
                    needsSave = true;
                    notificationMessage = 'Documento solucionado com sucesso!';
                }
                else if (button.classList.contains('acareacao-motorista-btn')) {
                    const confirmed = await openConfirmationModal({
                        title: 'Confirmar Extravio Motorista',
                        message: `Mover o documento '${currentData.files[fileIndex].fileName}' para Extravio Motorista?`
                    });
                    if (!confirmed) return;

                    currentData.files[fileIndex].status = 'extravio_motorista';
                    needsSave = true;
                    notificationMessage = 'Movido para Extravio Motorista.';
                }
                else if (button.classList.contains('acareacao-base-btn')) {
                    const confirmed = await openConfirmationModal({
                        title: 'Confirmar Extravio Base',
                        message: `Mover o documento '${currentData.files[fileIndex].fileName}' para Extravio Base?`
                    });
                    if (!confirmed) return;
                    
                    currentData.files[fileIndex].status = 'extravio_base';
                    needsSave = true;
                    notificationMessage = 'Movido para Extravio Base.';
                }
                else if (button.classList.contains('whatsapp-toggle-btn')) {
                    const file = currentData.files[fileIndex];
                    file.whatsappNotified = file.whatsappNotified === 'yes' ? 'no' : 'yes'; 
                    needsSave = true;
                    notificationMessage = `Status do WhatsApp atualizado para '${file.whatsappNotified === 'yes' ? 'Sim' : 'Não'}'.`;
                }

                if (needsSave) {
                    AppState = currentData; 
                    await saveData(AppState); 
                    render(AppState); 
                    if (notificationMessage) {
                        showNotification(notificationMessage);
                    }
                }
            });

            function setupFilters() {
                const now = new Date();
                const currentMonth = now.getMonth(); 
                const currentYear = now.getFullYear();

                while (yearFilterEl.options.length > 1) {
                    yearFilterEl.remove(1);
                }
                
                const startYear = 2024;
                
                let allYears = new Set();
                if(AppState.files) {
                    AppState.files.forEach(f => {
                         if(f.uploadDate) {
                            allYears.add(new Date(f.uploadDate).getFullYear());
                         }
                    });
                }
                allYears.add(startYear);
                allYears.add(currentYear);
                allYears.add(currentYear + 1);
                
                const sortedYears = Array.from(allYears).sort((a,b) => a - b);
                
                sortedYears.forEach(year => {
                    // Evita adicionar anos "NaN" se algum dado estiver corrompido
                    if (year && !isNaN(year)) { 
                        const option = new Option(year, year);
                        yearFilterEl.add(option);
                    }
                });

                monthFilterEl.value = currentMonth;
                // Garante que o ano atual exista como opção antes de tentar selecioná-lo
                if (yearFilterEl.querySelector(`option[value="${currentYear}"]`)) {
                    yearFilterEl.value = currentYear;
                } else {
                    // Se o ano atual não estiver na lista por algum motivo, seleciona "Todos"
                    yearFilterEl.value = "all"; 
                }


                monthFilterEl.addEventListener('change', () => render(AppState));
                yearFilterEl.addEventListener('change', () => render(AppState));
                
                resetFilterBtn.addEventListener('click', () => {
                    const now = new Date();
                    const month = now.getMonth();
                    const year = now.getFullYear();
                    
                    monthFilterEl.value = month;

                    let yearExists = false;
                    for (let i = 0; i < yearFilterEl.options.length; i++) {
                        if (yearFilterEl.options[i].value == year) {
                            yearExists = true;
                            break;
                        }
                    }
                    if (!yearExists) {
                         const option = new Option(year, year);
                         yearFilterEl.add(option);
                         let opts = Array.from(yearFilterEl.options);
                         opts.sort((a, b) => (a.value === 'all' ? -Infinity : a.text) - (b.value === 'all' ? -Infinity : b.text));
                         yearFilterEl.innerHTML = '';
                         opts.forEach(o => yearFilterEl.add(o));
                    }
                    yearFilterEl.value = year; 

                    render(AppState);
                    showNotification(`Filtro redefinido para o mês atual (${month + 1}/${year}).`);
                });
            }

            // --- Inicialização da aplicação ---
            
            async function initializeApp() {
                let initialData = await getLatestData(); // Mudei para let
                if (initialData) {
                    
                    // --- CORREÇÃO: SCRIPT DE REPARO DE ID ---
                    let needsRepair = false;
                    const idMap = new Map();
                    initialData.files.forEach(file => {
                        // Verifica se o ID não existe, é nulo, ou já foi visto
                        if (!file.id || idMap.has(file.id)) { 
                            console.warn(`Reparando ID do arquivo: ${file.fileName}`);
                            file.id = crypto.randomUUID(); // Atribui um novo ID único
                            needsRepair = true;
                        } else {
                            idMap.set(file.id, true);
                        }
                    });

                    if (needsRepair) {
                        console.log("IDs duplicados ou ausentes encontrados. Salvando dados reparados...");
                        
                        // CORREÇÃO: Verifica se o saveData teve sucesso
                        const saveSuccess = await saveData(initialData); 
                        
                        if (saveSuccess) {
                            showNotification("Reparo concluído! Recarregando...", false);
                            setTimeout(() => {
                               location.reload(); 
                            }, 2000); // Espera 2s para a notificação ser vista
                            
                            return; // Para a execução atual
                        } else {
                            // CORREÇÃO: Se o save falhar (provavelmente DB muito grande),
                            // notifica o usuário mas continua carregando o app
                            // para quebrar o loop de recarregamento.
                            showNotification("Falha ao salvar reparo (Banco de dados muito grande). Carregando app...", true);
                            // Não retorna e não recarrega, continua para carregar o app.
                        }
                    }
                    // --- FIM DO SCRIPT DE REPARO ---

                    AppState = initialData;
                    setupFilters(); 
                    render(AppState); 
                } else {
                    if (loadingEl) loadingEl.style.display = 'none';
                    showNotification("Falha ao carregar dados iniciais.", true);
                    setupFilters(); 
                    render(AppState); 
                }
                startAutoUpdate(); 
            }
            
            function startAutoUpdate() {
                clearInterval(autoUpdateInterval); 
                autoUpdateInterval = setInterval(async () => {
                    if (isSaving) return; 

                    const data = await getLatestData();
                    if (data) {
                        const dataChanged = JSON.stringify(data) !== JSON.stringify(AppState);
                        
                        const oldYears = new Set(AppState.files.map(f => f.uploadDate ? new Date(f.uploadDate).getFullYear() : null));
                        const newYears = new Set(data.files.map(f => f.uploadDate ? new Date(f.uploadDate).getFullYear() : null));
                        
                        let yearsChanged = oldYears.size !== newYears.size;
                        if (!yearsChanged) {
                             oldYears.forEach(y => {
                                if(y && !newYears.has(y)) yearsChanged = true;
                             });
                        }
                        
                        AppState = data;

                        if (yearsChanged) {
                            const currentMonth = monthFilterEl.value;
                            const currentYear = yearFilterEl.value;
                            setupFilters(); 
                            monthFilterEl.value = currentMonth;
                            yearFilterEl.value = currentYear;
                        }

                        if (dataChanged) {
                            render(AppState);
                            showNotification("Lista atualizada automaticamente.", false);
                        } else {
                            render(AppState);
                        }
                    }
                }, 30000); // 30 segundos
            }
            
            initializeApp(); 
        });
    </script>
</body>
</html>
